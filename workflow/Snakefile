#report: "../report/main.rst"
import os 


configfile: "../config/config.yaml"
#validate(config, schema="../config/config.schema.yaml")

# Paths in include and configfile are relative to the Snakefile
# paths inside the rules are relative to where you run the command.

# CHROMOSOMES = range(1, 22)
CHROMOSOMES = range(20, 22)


# workflow.report_metadata.category_descriptions= {
#         "Initial QC": "../report/qc_intro.rst",
#         "Dimension reduction": "../report/dimensionReduction.rst",
#         "Ancestry Analysis": "../report/ancestry_intro.rst",
#         "Ancestry Specific QC": "../report/ancestrySpecificqc_intro.rst",
#     }

PREVIOUS_STEP = {
    "01-Initialfilter": "00-raw",
    "02-relatedness": "01-Initialfilter",
}

def get_input_by_stage(wildcards):
    # Fix the typo 'wilcards' -> 'wildcards'
    if wildcards.stage == "01-Initialfilter":
        input_prefix = "data"
    else:
        input_prefix = "initialFilter"

    # Ensure the stage exists in the map to avoid KeyErrors
    if wildcards.stage not in PREVIOUS_STEP:
        raise ValueError(f"Stage {wildcards.stage} not defined in PREVIOUS_STEP map.")

    prev = PREVIOUS_STEP[wildcards.stage]
    
    # Use os.path.abspath to make it bulletproof for SLURM
    path = os.path.join(config["OUT_DIR"], prev, input_prefix)
    return os.path.abspath(path)

# 1. Version-agnostic check
is_singularity = (
    getattr(workflow, "use_singularity", False) or 
    "singularity" in str(getattr(workflow.deployment_settings, "deployment_method", ""))
)

if is_singularity:
    # Start with the essentials
    bind_paths = {os.getcwd(), "/scratch", "/tmp"}

    # 2. Extract paths from config/params
    # This function looks for any string in your config that is an existing directory
    def find_paths(d):
        for val in d.values():
            if isinstance(val, str) and "/" in val:
                # If it's a file, get the parent directory
                potential_path = os.path.abspath(val)
                parent = os.path.dirname(potential_path)
                if os.path.exists(parent):
                    bind_paths.add(parent)
            elif isinstance(val, dict):
                find_paths(val)

    find_paths(config)

    # 3. Clean up and set the environment variable
    # We use a set to ensure no duplicates, then join with commas
    os.environ["APPTAINER_BIND"] = ",".join(filter(None, bind_paths))
    os.environ["APPTAINER_WRITABLE_TMPFS"] = "1"

    print(f"DEBUG: Active Binds: {os.environ['APPTAINER_BIND']}")



include: "rules/LinkData.smk"
include: "rules/Initial_QC.smk"
include: "rules/Relatedness.smk"
include: "rules/Standard_QC.smk"
include: "rules/phase.smk"
include: "rules/RFMIX.smk"
include: "rules/PCA.smk"
include: "rules/plotInitial_QC.smk"
include: "rules/umap.smk"


rule all:
    threads: 1
    resources:
        nodes = 1,
        mem_mb = 4000,
        runtime = 420 # 1 week
    input:
        # Requesting this file triggers Initial_QC for the first stage
        # os.path.join(config['OUT_DIR'], "00-raw/data.bed")
        #os.path.join(config['OUT_DIR'], "01-Initialfilter/initialFilter.bed")
        #os.path.join(config['OUT_DIR'], "02-relatedness/unrelated.bed"),
        #os.path.join(config['OUT_DIR'], "02-relatedness/initialFilter.bed")
        #os.path.join(config['OUT_DIR'], "02-relatedness/standardFiltered.bed")
        os.path.join(config['OUT_DIR'], "04-globalAncestry/merged_dataset_pca.eigenvec"),
        expand(f"{config['OUT_DIR']}/03-localAncestry/chr{{CHR}}.phased.vcf.gz", CHR=CHROMOSOMES),

rule report:
    threads: 1
    resources:
        nodes = 1,
        mem_mb = 4000,
        runtime = 420 # 1 week
    input:
        imiss = os.path.join(config['OUT_DIR'], "figures/imiss.png"),
        lmiss = os.path.join(config['OUT_DIR'], "figures/lmiss.png")

rule run_pca:
    threads: 1
    resources:
        nodes = 1,
        mem_mb = 4000,
        runtime = 420 # 1 week
    input:
        os.path.join(config['OUT_DIR'], "04-globalAncestry/merged_dataset_pca.eigenvec")

rule run_umap:
    threads: 1
    resources:
        nodes = 1,
        mem_mb = 4000,
        runtime = 420 # 1 week
    input:
        os.path.join(config['OUT_DIR'], "04-globalAncestry/umap.csv")

rule run_phase:
    threads: 1
    resources:
        nodes = 1,
        mem_mb = 4000,
        runtime = 420 # 1 week
    input:
        expand(f"{config['OUT_DIR']}/03-localAncestry/chr{{CHR}}.phased.vcf.gz", CHR=CHROMOSOMES),
