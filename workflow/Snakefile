#report: "../report/main.rst"

configfile: "../config/config.yaml"
#validate(config, schema="../config/config.schema.yaml")

# Paths in include and configfile are relative to the Snakefile
# paths inside the rules are relative to where you run the command.

# CHROMOSOMES = range(1, 22)
CHROMOSOMES = range(20, 21)


# run single rule
# snakemake --cores 1 Initial_QC --config stage=01-Initialfilter
# snakemake --jobs 22 --configfile ../config/config2.yaml --cluster "sbatch --parsable" --use-singularity
# snakemake --jobs 22 --configfile ../config/config.yaml --cluster "sbatch --parsable"
import os 
PREVIOUS_STEP = {
    "01-Initialfilter": "00-raw",
    "02-relatedness": "01-Initialfilter",
}

def get_input_by_stage(wildcards):
    # Fix the typo 'wilcards' -> 'wildcards'
    if wildcards.stage == "01-Initialfilter":
        input_prefix = "data"
    else:
        input_prefix = "initialFilter"

    # Ensure the stage exists in the map to avoid KeyErrors
    if wildcards.stage not in PREVIOUS_STEP:
        raise ValueError(f"Stage {wildcards.stage} not defined in PREVIOUS_STEP map.")

    prev = PREVIOUS_STEP[wildcards.stage]
    
    # Use os.path.abspath to make it bulletproof for SLURM
    path = os.path.join(config["OUT_DIR"], prev, input_prefix)
    return os.path.abspath(path)



import os

def get_mount_roots(config_dict):
    """
    Recursively scans the config for absolute paths and extracts 
    the top-level root (e.g., /shared, /scratch) for mounting.
    """
    roots = set()
    for value in config_dict.values():
        if isinstance(value, str) and value.startswith("/"):
            # Resolve symlinks to find the true physical disk path
            real_p = os.path.realpath(value)
            parts = real_p.split("/")
            if len(parts) > 1:
                roots.add(f"/{parts[1]}")
        elif isinstance(value, dict):
            roots.update(get_mount_roots(value))
    return roots

# Initialize auto-binding if Singularity/Apptainer is active
if workflow.use_singularity:
    # 1. Start with the current working directory
    # Using realpath here ensures the project folder is mapped correctly
    active_roots = {os.path.realpath(os.getcwd()).split("/")[1]}
    active_roots = {f"/{r}" if not r.startswith("/") else r for r in active_roots}

    # 2. Add roots from absolute paths found in config
    active_roots.update(get_mount_roots(config))

    # 3. Create the comma-separated string required by Apptainer
    # Format: "/shared,/scratch,/project"
    bind_string = ",".join(active_roots)

    # 4. Inject into environment variables
    # These are automatically picked up by Singularity/Apptainer exec
    os.environ["APPTAINER_BIND"] = bind_string
    os.environ["SINGULARITY_BIND"] = bind_string

    # 5. Optional: Print for user transparency
    print(f"--- Container Auto-Mount Active ---")
    print(f"Bound Roots: {bind_string}")
    print(f"------------------------------------")


include: "rules/LinkData.smk"
include: "rules/Initial_QC.smk"
include: "rules/Relatedness.smk"
include: "rules/Standard_QC.smk"
include: "rules/RFMIX.smk"
include: "rules/PCA.smk"
#include: "rules/plotInitial_QC.smk"

rule all:
    threads: 1
    resources:
        # nodes=1 is usually the default, but can be specified if needed
        nodes = 1,
        mem_mb = 4000,
        runtime = 420 # 1 week
    input:
        # Requesting this file triggers Initial_QC for the first stage
        # os.path.join(config['OUT_DIR'], "00-raw/data.bed")
        #os.path.join(config['OUT_DIR'], "01-Initialfilter/initialFilter.bed")
        #os.path.join(config['OUT_DIR'], "02-relatedness/unrelated.bed"),
        #os.path.join(config['OUT_DIR'], "02-relatedness/initialFilter.bed")
        #os.path.join(config['OUT_DIR'], "02-relatedness/standardFiltered.bed")
        os.path.join(config['OUT_DIR'], "04-globalAncestry/merged_dataset_pca.eigenvec")
        #expand(f"{config['OUT_DIR']}/03-localAncestry/chr{{CHR}}.phased.vcf.gz", CHR=CHROMOSOMES),
        # imiss = os.path.join(config['OUT_DIR'], "figures/imiss.png"),
        #lmiss = os.path.join(config['OUT_DIR'], "figures/lmiss.png")
